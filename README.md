# Souli Voice Data Pipeline (Production Skeleton)

This repo turns **YouTube videos / playlists** into clean, structured datasets (chunks, teaching cards, etc.)
and supports your existing **Energy Framework** Excel normalization/enrichment workflow.

It is designed to run:
- locally (Mac/Linux/Windows)
- on a GPU VM (Compute Engine / any docker host)
- as a batch job (playlist → many videos)

## What it does

### A) Energy Framework (Excel)
- Loads `ExpressionsMapping` + `Inner energy Framework`
- Normalizes `Aspects of Woman Track` and `energy_node`
- Heuristically fills missing `energy_node` when blank
- Enriches rows with framework columns
- Applies a strict quality gate → `gold` and `reject`
- Optional recovery passes similar to your notebook (dual/blocks repair)

### B) YouTube → Chunks → Teaching Cards
- Tries captions first (VTT via yt-dlp)
- Falls back to audio + faster-whisper (optional; requires ffmpeg)
- Builds coherent chunks based on time, word limits, gaps
- Cleans/dedupes noisy captions
- Classifies chunks (problem / teaching / noise)
- Scores and filters teaching chunks
- (Optional) Calls an LLM adapter to extract **strict JSON cards**

> Note: For LLM extraction you can plug your own model endpoint or local HF model.
> This skeleton ships with a clean interface so you can swap providers safely.

## Quickstart

### 1) Create venv
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 2) Run a single video
```bash
souli run youtube \
  --config configs/pipeline.yaml \
  --youtube-url "https://youtu.be/VIDEO_ID"
```

### 3) Run a playlist (batch)
```bash
souli run playlist \
  --config configs/pipeline.yaml \
  --playlist-url "https://www.youtube.com/playlist?list=PLAYLIST_ID"
```

### 4) Process Excel energy framework
```bash
souli run energy \
  --config configs/pipeline.yaml \
  --excel-path data/Souli_EnergyFramework_PW.xlsx
```

### 5) Run many videos from a CSV (different data per video)
Use a CSV with column `url` or `youtube_url`. Optional columns: `name`, `video_id`, `title` (used as `source_video` in merged outputs).
```bash
souli run videos \
  --config configs/pipeline.yaml \
  --videos-csv data/videos.csv \
  --merge
```
Each video gets its own folder: `outputs/<run_id>/youtube/video_001/`, `video_002/`, …  
With `--merge` you also get:
- `outputs/<run_id>/youtube/merged_teaching_ready.xlsx` — all teaching chunks with **source_video** column
- `outputs/<run_id>/youtube/merged_teaching_cards.xlsx` — all teaching cards with **source_video** (when LLM is enabled)

See `data/videos.csv.example` for CSV format.

### 6) Full run: energy + all videos in one go
```bash
souli run all \
  --config configs/pipeline.yaml \
  --videos-csv data/videos.csv \
  --excel-path data/Souli_EnergyFramework_PW.xlsx \
  --merge
```

## Outputs

All outputs go to `outputs/<run_id>/...`:
- **Per video**: `youtube/video_001/`, `video_002/`, … each with:
  - `segments.xlsx`, `chunks_raw.xlsx`, `chunks_clean.xlsx`, `chunks_keep.xlsx`, `teaching_ready.xlsx`, `teaching_cards.xlsx` (if LLM on)
- **Merged** (when using `run videos` or `run all` with `--merge`):
  - `youtube/merged_teaching_ready.xlsx`, `youtube/merged_teaching_cards.xlsx` (column **source_video** = URL or name from CSV)
- **Energy**: `energy/gold.xlsx`, `energy/reject.xlsx`

## Docker & Cloud

Build:
```bash
docker build -t souli-pipeline .
```

Run (mount working directory so config, data, and outputs live on host):
```bash
docker run --rm -it \
  -v "$PWD:/app" \
  -w /app \
  souli-pipeline \
  souli run videos --config configs/pipeline.yaml --videos-csv data/videos.csv --merge
```

For **all videos** from CSV + optional energy Excel:
```bash
docker run --rm -it \
  -v "$PWD:/app" \
  -w /app \
  souli-pipeline \
  souli run all --config configs/pipeline.yaml --videos-csv data/videos.csv --excel-path data/Souli_EnergyFramework_PW.xlsx --merge
```

- Put your `videos.csv` and `Souli_EnergyFramework_PW.xlsx` in `data/` (or any path you mount).
- Outputs go to `outputs/<run_id>/` on the host.
- If using whisper fallback, you need `ffmpeg` (included in Docker image).
- On a cloud VM, run the same commands; use a persistent disk or object storage for `outputs/` and `data/`.

## Environment variables

- `SOULI_LOG_LEVEL` (default: INFO)
- `SOULI_RUN_ID` (optional; otherwise autogenerated)
- LLM adapter vars (depends on which adapter you enable)

## License
Internal use.
